<h1> TechMartApi </h1>

<h2> Команды</h2>

Установка библиотек:  
  ```
  pip install -r requirements.txt
  ```

Запуск сервера:  
```
uvicorn main:app --reload
```

Для просмотра документации и получения примеров заполнения напишите ```/docs``` в конце полученой ссылки
```
http://127.0.0.1:8000/docs
```

<h2>Настройте переменные окружения.</h2> 

Создайте файл .env в корневой папке проекта и заполните его:

```
# .env
SECRET_KEY="your_super_secret_key_that_is_long_and_random"
ALGORITHM="HS256"
ACCESS_TOKEN_EXPIRE_MINUTES=30
```

<h2> Контроль доступа на основе ролей</h2>
<p>Система строго разделяет права доступа в зависимости от роли пользователя, что обеспечивает безопасность и логику бизнес-процессов.</p> 

Администраторы
* Имеют полный доступ ко всей системе.
* Могут просматривать список всех пользователей (включая других администраторов).
* Могут создавать, удалять и редактировать товары.
* Могут удалять учетные записи любых пользователей.
* ID администраторов для внутреннего учета начинается с префикса «a».

Работники
* Имеют права на управление товарами и покупателями.
* Могут просматривать список только работников и покупателей, но не видят администраторов.
* Могут создавать, удалять и редактировать товары.
* Могут удалять только учетные записи покупателей.
* ID работников начинается с префикса «w».

Покупатели
* Имеют ограниченные права, предназначенные только для совершения покупок.
* Могут просматривать каталог товаров и покупать их.
* Не могут просматривать списки пользователей или управлять товарами.
* ID покупателей начинается с префикса «c».

<h2> Эндпоинты API </h2>
<p>API предоставляет следующие маршруты для взаимодействия с системой:</p>

Аутентификация (```BODY``` > ```raw```)
* POST ```/api/admin-reg``` — Регистрация администратора.
* POST ```/api/worker-reg``` — Регистрация работника.
* POST ```/api/customer-reg``` — Регистрация покупателя.
* POST ```/api/token``` — Вход в систему и получение токена доступа через Body, выберите form-data.
---
Для входа в аккаунт добавьте два ключа в ```BODY``` ```form-data```:

```username: myadmin```

```password: strongpassword```

Отправьте запрос. В ответе вы получите ```access_token```.

<h2>Доступ к защищенным эндпоинтам:</h2>

* Скопируйте полученный ```access_token```.
* Создайте новый запрос, например GET на ```http://127.0.0.1:8000/api/user/```.
* Перейдите во вкладку ```Authorization```.
* Выберите ```Type: Bearer Token```.
* Вставьте скопированный токен в поле ```Token```.
* Отправьте запрос. Вы получите список пользователей, так как у вас токен админа.

---
Управление пользователями
* GET ```/api/user/``` — Выводит список пользователей (результат зависит от роли запрашивающего).
* GET ```/api/user/{user_id}``` — Получить информацию о конкретном пользователе.
* DELETE ```api/delete-user/{user_id}``` — Удалить пользователя (доступно администраторам и работникам с ограничениями).

Управление категориями (только для администраторов и работников)
* GET ```/api/products/category/``` — Выводит список всех категорий.
* POST ```/api/products/category/``` — Создать новую категорию.
* GET ```/api/products/category/{category_name}``` — Выводит список товаров заданой категории.

Управление товарами
* GET ```/api/products/``` — Выводит список всех товаров (доступно всем авторизованным пользователям).
* POST ```/api/products/``` — Создать новый товар (только для администраторов и работников).
* DELETE ```/api/products/{product_id}``` — Удалить товар (только для администраторов и работников).
* POST ```/api/products/{product_id}/purchase``` — Купить товар (только для покупателей).

Редактирование товаров
* PATCH ```/api/products/{product_id}``` — Отредактировать существующий товар (только для администраторов и работников).
* PATCH ```/api/products/{product_id}/form``` — Отредактировать существующий товар через form-body(только для администраторов и работников).
```
{
  "name": "string",
  "description": "string",
  "price": 0,
  "category": "string",
  "quantity": 0
}
```
<p>
  Отредактировать можно либо весь товар полностью либо укажите определенные поля которые должны быть изменены к примеру указать "name": "new_name"
</p>

* PUT 
```/api/products/{product_id}/update-quantity``` — Отредактировать только количество товаров (только для администраторов и работников).
Чтобы добавить 30 единиц товара
```
{
  "change": 30 
}
```
Чтобы отнять 30 единиц товара припишите - 
```
{
  "change": -30 
}
```

Поиск
* POST ```/api/products/search``` — Выводит список товаров и поиск мин-макс стоимости (доступно ВСЕМ авторизованным пользователям).
* POST ```/api/user/search``` — Выводит список пользователей (только для администраторов и работников).
* Универсальный поиск search ищет совпадения по нескольким ключевым полям (имя, ID, роль и т.д.)
* Специализированные фильтры (id, username, min_price и т.д.) позволяют задать точные условия.
  
Пользователи
```
{
  "search": "string",///Универсальный поиск
  ///Фильтры
  "id": "string",
  "username": "string",
  "role": "string"
}
```

Товары
```
{
  "search": "string",///Универсальный поиск
  ///Фильтры
  "id": "string",
  "name": "string",
  "category": "string",
  "min_price": 0,
  "max_price": 0
}
```

Покупка товара (для покупателя):
---
Зарегистрируйтесь как ```customer``` и получите его токен.
Создайте POST запрос на 
```
http://127.0.0.1:8000/api/products/{product_id}/purchase
```
заменив ```{product_id}``` на реальный ID товара (например, ```p1```).
Настройте Authorization с токеном покупателя.

<h2>Тестирование</h2>

Для запуска автоматизированных тестов используйте pytest.

```
pytest
```
<br>
<h2>Дополнительно</h2>

<h3>Валидация</h3>

Принцип работы валидации в API

Валидация в проекте является многоуровневой и распределена по нескольким файлам, каждый из которых выполняет свою специфическую задачу. Это обеспечивает как проверку данных, так и безопасность доступа.

```models/models.py``` Что делает: Это первый и основной уровень валидации, отвечающий за структуру данных. С помощью Pydantic-моделей FastAPI автоматически проверяет, что все входящие запросы (например, тело POST-запроса) соответствуют заданной схеме: все обязательные поля присутствуют, и их типы данных корректны. Если данные невалидны, API автоматически возвращает ошибку 422 Unprocessable Entity.

```security/security.py``` Что делает: Это ядро валидации пользователя и его прав доступа. Здесь находятся функции-зависимости (Depends), которые проверяют JWT-токен из заголовка запроса, его подлинность и срок действия (get_current_user). На основе этой базовой проверки строятся другие, более строгие, валидирующие роль пользователя (get_admin_user, get_worker_user).

```routers/auth.py``` Что делает: Отвечает за валидацию при аутентификации. При попытке входа (/token) он проверяет совпадение логина и пароля. При регистрации — валидирует уникальность имени пользователя, чтобы избежать дубликатов.

```routers/products.py и routers/users.py``` Что делает: На этом уровне происходит применение правил валидации для защиты конкретных эндпоинтов. Путем добавления зависимостей из security.py (например, Depends(get_worker_user)) в определение эндпоинта, доступ к нему ограничивается только для пользователей с подтвержденными правами. Здесь же может происходить и валидация бизнес-логики, например, проверка существования категории перед добавлением товара.

